# analyzer.py
import os
import pandas as pd
from app.data_load import DataLoader
from app.utils import format_answer

class DataAnalyzer:
    def __init__(self, model_loader, data_loader: DataLoader):
        self.model_loader = model_loader
        self.data = data_loader.data

    def ask(self, question: str):
        schema_desc = """
        –î–∞—Ç–∞—Å–µ—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–ª–µ–¥—É—é—â–∏–µ –∫–æ–ª–æ–Ω–∫–∏:
        - Freelancer_ID: —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∫–∞–∂–¥–æ–≥–æ —Ñ—Ä–∏–ª–∞–Ω—Å–µ—Ä–∞
        - Job_Category: –ü–µ—Ä–≤–∏—á–Ω–∞—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω—è–µ–º–æ–π –≤–Ω–µ—à—Ç–∞—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã. –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö string. –ü—Ä–∏–º–µ—Ä—ã: Web Development, Data Entry, Content Writing
        - Platform: –¢–æ—Ä–≥–æ–≤–∞—è –ø–ª–æ—â–∞–¥–∫–∞ —Ñ—Ä–∏–ª–∞–Ω—Å–µ—Ä–æ–≤, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–π –±—ã–ª–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —Ä–∞–±–æ—Ç–∞. –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö string. –ü—Ä–∏–º–µ—Ä—ã: Fiverr, Upwork, Toptal, Freelancer, PeoplePerHour
        - Experience_Level: –£—Ä–æ–≤–µ–Ω—å –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –æ–ø—ã—Ç–∞ —Ñ—Ä–∏–ª–∞–Ω—Å–µ—Ä–∞. –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö string. –ü—Ä–∏–º–µ—Ä—ã: Beginner, Intermediate, Expert
        - Client_Region: –ì–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞. –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö string. –ü—Ä–∏–º–µ—Ä—ã: Asia, Europe, USA, Canada, UK, Australia, Middle East
        - Payment_Method: –ú–µ—Ç–æ–¥, –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –¥–ª—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π. –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö string. –ü—Ä–∏–º–µ—Ä—ã: Bank Transfer, PayPal, Mobile Banking, Crypto
        - Job_Completed: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤. –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö integer. –ü—Ä–∏–º–µ—Ä—ã: 180, 218, 27
        - Earnings_USD: –û–±—â–∞—è –ø—Ä–∏–±—ã–ª—å –≤ –¥–æ–ª–ª–∞—Ä–∞—Ö –°–®–ê. –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö float. –ü—Ä–∏–º–µ—Ä—ã: 1620, 9078, 3455
        - Hourly_Rate: –°—Ç–∞–≤–∫–∞ –ø–æ—á–∞—Å–æ–≤–æ–π –æ–ø–ª–∞—Ç—ã —Ç—Ä—É–¥–∞ —Ñ—Ä–∏–ª–∞–Ω—Å–µ—Ä–∞ –≤ –¥–æ–ª–ª–∞—Ä–∞—Ö –°–®–ê. –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö float. –ü—Ä–∏–º–µ—Ä—ã: 95.79, 86.38, 85.17
        - Job_Success_Rate: –ü—Ä–æ—Ü–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏–π. –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö float. –ü—Ä–∏–º–µ—Ä—ã: 68.73, 97.54, 86.6
        - Client_Rating: –°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞, –¥–∞–Ω–Ω–∞—è –∫–ª–∏–µ–Ω—Ç–∞–º–∏ (–ø–æ —à–∫–∞–ª–µ –æ—Ç 1,0 –¥–æ 5,0). –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö float. –ü—Ä–∏–º–µ—Ä—ã: 3.18, 3.44, 4.2
        - Job_Duration_Days: –°—Ä–µ–¥–Ω–∏–π —Å—Ä–æ–∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞ –≤ –¥–Ω—è—Ö. –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö integer. –ü—Ä–∏–º–µ—Ä—ã: 1, 54, 46
        - Project_Type: –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç. –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö string. –ü—Ä–∏–º–µ—Ä—ã: Fixed, Hourly
        - Rehire_Rate: –ü—Ä–æ—Ü–µ–Ω—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–≤—Ç–æ—Ä–Ω–æ –Ω–∞–Ω–∏–º–∞—é—Ç —Ñ—Ä–∏–ª–∞–Ω—Å–µ—Ä–∞. –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö float. –ü—Ä–∏–º–µ—Ä—ã: 40.19, 36.53, 74.05
        - Marketing_Spend: –°—É–º–º–∞ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π –≤ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã –≤ –¥–æ–ª–ª–∞—Ä–∞—Ö –°–®–ê. –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö integer. –ü—Ä–∏–º–µ—Ä—ã: 53, 486, 489
        """

        prompt = f"""
        {schema_desc}
        
        –ü—Ä–µ–æ–±—Ä–∞–∑—É–π —Å–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å –≤ Python —Å–∫—Ä–∏–ø—Ç, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏–µ–π eval(). 
        –í –æ—Ç–≤–µ—Ç–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ —Ç—ã –¥–æ–ª–∂–µ–Ω –Ω–∞–ø–∏—Å–∞—Ç—å —Ç–æ–ª—å–∫–æ –∫–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∏–∫–∞–∫ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω.
        –°–∫—Ä–∏–ø—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞–ø–∏—Å–∞–Ω —Å –∏—Å–ø–æ–ª—å—â–æ–≤–∞–Ω–∏–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ pandas. 
        –¢—ã –¥–æ–ª–∂–µ–Ω –Ω–∞–ø–∏—Å–∞—Ç—å –∫–æ–¥, –∫–æ—Ç–æ—Ä—ã–π:
        - –°—á–∏—Ç–∞–µ—Ç –¥–∞—Ç–∞—Å–µ—Ç –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞ "./data/freelancer_earnings_bd.csv"
        - –ü—Ä–æ–∏–∑–≤–µ–¥–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ –¥–∞–Ω–Ω—ã–º, —É—á–∏—Ç—ã–≤–∞—è –ø—Ä–∏ —ç—Ç–æ–º –∑–∞–ø—Ä–æ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        - –°–æ—Ö—Ä–∞–Ω–∏—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é result
        - –£—á—Ç–∏, —á—Ç–æ –≤—ã–≤–æ–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –¥–æ–ª–∂–µ–Ω —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è —Å–æ–≥–ª–∞—Å—Å–Ω–æ –∑–∞–ø—Ä–æ—Å—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á—Ç–æ–±—ã –µ–≥–æ —É–¥–æ–±–Ω–æ —á–∏—Ç–∞—Ç—å. 
        - –î–æ–ø–æ–ª–Ω–∏ –æ—Ç–≤–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏ –∏ —Å–æ—Ö—Ä–∞–Ω–∏ –µ–≥–æ –≤–≤–∏–¥–µ —Å—Ç—Ä–æ–∫–∏ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é result
        
        –ö–∞—Ç–µ–≥–æ—Ä–∏—á–µ—Å–∫–∏ –∑–∞–ø—Ä–µ—â–∞–µ—Ç—Å—è –¥–µ–ª–∞—Ç—å —Å–ª–µ–¥—É—é—â–µ–µ:
        - –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥ –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å/—É–¥–∞–ª—è—Ç—å/–∏–∑–º–µ–Ω—è—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–∞–π–ª–∞.
        - –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥ –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç —É–¥–∞–ª—è—Ç—å/–ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞—Ç—å/–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å/–ø–µ—Ä–µ–º–µ—â–∞—Ç—å –Ω–∞–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö.
        
        –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –∑–∞–ø—Ä–µ—â–µ–Ω, —Ç–æ –≤—ã–¥–∞–π –æ—Ç–≤–µ—Ç "–Ø –Ω–µ –º–æ–≥—É –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å —Ç–∞–∫–æ–≥–æ —Ä–æ–¥–∞"
        –ï—Å–ª–∏ —Ç—ã –Ω–µ –º–æ–∂–µ—à—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å –Ω–∞–ø–∏—à–∏ - "–ú–Ω–µ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –Ω–∞ –≤–∞—à –≤–æ–ø—Ä–æ—Å. –ü–æ—Å—Ç–∞—Ä–∞–π—Ç–µ—Å—å —É—Ç–æ—á–Ω–∏—Ç—å –µ–≥–æ." –∏ —Å–æ—Ö—Ä–∞–Ω–∏ –µ–≥–æ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é result
        
        –ù–∏–∂–µ –ø—Ä–∏–≤–µ–¥–µ–Ω—ã –ø—Ä–∏–º–µ—Ä—ã —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–¥–∞:
        
        –ü—Ä–∏–º–µ—Ä 1
        import pandas as pd

        # –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        df = pd.read_csv("./data/freelancer_earnings_bd.csv")

        # –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ä–µ–≥–∏–æ–Ω—É –∫–ª–∏–µ–Ω—Ç–∞ (–ï–≤—Ä–æ–ø–∞)
        europe_freelancers = df[df["Client_Region"] == "Europe"]

        # –í—ã—á–∏—Å–ª–µ–Ω–∏–µ —Å—Ä–µ–¥–Ω–µ–≥–æ –¥–æ—Ö–æ–¥–∞
        average_earnings_europe = europe_freelancers["Earnings_USD"].mean()

        result = f"–°—Ä–µ–¥–Ω–∏–π –¥–æ—Ö–æ–¥ —Ñ—Ä–∏–ª–∞–Ω—Å–µ—Ä–æ–≤ —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏ –∏–∑ –ï–≤—Ä–æ–ø—ã: " + average_earnings_europe + " USD"
        
        –ü—Ä–∏–º–µ—Ä 2
        
        import pandas as pd

        # –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        df = pd.read_csv("./data/freelancer_earnings_bd.csv")

        # –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ñ—Ä–∏–ª–∞–Ω—Å–µ—Ä–æ–≤ —Å —Ä–µ–π—Ç–∏–Ω–≥–æ–º >= 4.5
        high_rated = df[df["Client_Rating"] >= 4.5]

        # –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ —É—Ä–æ–≤–Ω—é –æ–ø—ã—Ç–∞ –∏ –ø–æ–¥—Å—á—ë—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
        experience_counts = high_rated["Experience_Level"].value_counts()

        # –ù–∞—Ö–æ–∂–¥–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è —Å –Ω–∞–∏–±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º
        most_common_exp_level = experience_counts.idxmax()
        count = experience_counts.max()

        result = "–ß–∞—â–µ –≤—Å–µ–≥–æ –≤—ã—Å–æ–∫–∏–π —Ä–µ–π—Ç–∏–Ω–≥ –ø–æ–ª—É—á–∞—é—Ç —Ñ—Ä–∏–ª–∞–Ω—Å–µ—Ä—ã —É—Ä–æ–≤–Ω—è: " + most_common_exp_level
        result += f"–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–∞–∫–∏—Ö —Ñ—Ä–∏–ª–∞–Ω—Å–µ—Ä–æ–≤: " + count
        
        
        –í–æ–ø—Ä–æ—Å: "{question}"
        
        –ö–æ–¥:
        """

        response = self.model_loader.llm(prompt)
        code = response[0]['generated_text']

        print("üß† –ú–æ–¥–µ–ª—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª–∞ –∫–æ–¥:")
        print(code)

        local_vars = {'df': self.data, 'result': None}

        try:
            exec(code, globals(), local_vars)
            result = local_vars.get('result', '–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã—á–∏—Å–ª–∏—Ç—å')
            if result is None:
                result = "–ú–Ω–µ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –Ω–∞ –≤–∞—à –≤–æ–ø—Ä–æ—Å. –ü–æ—Å—Ç–∞—Ä–∞–π—Ç–µ—Å—å —É—Ç–æ—á–Ω–∏—Ç—å –µ–≥–æ."
            return format_answer(question, result)
        except Exception as e:
            # return f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∫–æ–¥–∞: {str(e)}"
            return f""
