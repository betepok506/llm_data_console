# analyzer.py
import os
import pandas as pd
from app.data_load import DataLoader
from app.utils import format_answer

class DataAnalyzer:
    def __init__(self, model_loader, data_loader: DataLoader):
        self.model_loader = model_loader
        self.data = data_loader.data

    def ask(self, question: str):
        schema_desc = """
        –î–∞—Ç–∞—Å–µ—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–ª–µ–¥—É—é—â–∏–µ –∫–æ–ª–æ–Ω–∫–∏:
        - Freelancer_ID: —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∫–∞–∂–¥–æ–≥–æ —Ñ—Ä–∏–ª–∞–Ω—Å–µ—Ä–∞
        - Job_Category: –ü–µ—Ä–≤–∏—á–Ω–∞—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω—è–µ–º–æ–π –≤–Ω–µ—à—Ç–∞—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã. –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö string. –ü—Ä–∏–º–µ—Ä—ã: Web Development, Data Entry, Content Writing
        - Platform: –¢–æ—Ä–≥–æ–≤–∞—è –ø–ª–æ—â–∞–¥–∫–∞ —Ñ—Ä–∏–ª–∞–Ω—Å–µ—Ä–æ–≤, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–π –±—ã–ª–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —Ä–∞–±–æ—Ç–∞. –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö string. –ü—Ä–∏–º–µ—Ä—ã: Fiverr, Upwork, Toptal, Freelancer, PeoplePerHour
        - Experience_Level: –£—Ä–æ–≤–µ–Ω—å –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –æ–ø—ã—Ç–∞ —Ñ—Ä–∏–ª–∞–Ω—Å–µ—Ä–∞. –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö string. –ü—Ä–∏–º–µ—Ä—ã: Beginner, Intermediate, Expert
        - Client_Region: –ì–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞. –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö string. –ü—Ä–∏–º–µ—Ä—ã: Asia, Europe, USA, Canada, UK, Australia, Middle East
        - Payment_Method: –ú–µ—Ç–æ–¥, –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –¥–ª—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π. –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö string. –ü—Ä–∏–º–µ—Ä—ã: Bank Transfer, PayPal, Mobile Banking, Crypto
        - Job_Completed: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤. –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö integer. –ü—Ä–∏–º–µ—Ä—ã: 180, 218, 27
        - Earnings_USD: –û–±—â–∞—è –ø—Ä–∏–±—ã–ª—å –≤ –¥–æ–ª–ª–∞—Ä–∞—Ö –°–®–ê. –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö float. –ü—Ä–∏–º–µ—Ä—ã: 1620, 9078, 3455
        - Hourly_Rate: –°—Ç–∞–≤–∫–∞ –ø–æ—á–∞—Å–æ–≤–æ–π –æ–ø–ª–∞—Ç—ã —Ç—Ä—É–¥–∞ —Ñ—Ä–∏–ª–∞–Ω—Å–µ—Ä–∞ –≤ –¥–æ–ª–ª–∞—Ä–∞—Ö –°–®–ê. –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö float. –ü—Ä–∏–º–µ—Ä—ã: 95.79, 86.38, 85.17
        - Job_Success_Rate: –ü—Ä–æ—Ü–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏–π. –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö float. –ü—Ä–∏–º–µ—Ä—ã: 68.73, 97.54, 86.6
        - Client_Rating: –°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞, –¥–∞–Ω–Ω–∞—è –∫–ª–∏–µ–Ω—Ç–∞–º–∏ (–ø–æ —à–∫–∞–ª–µ –æ—Ç 1,0 –¥–æ 5,0). –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö float. –ü—Ä–∏–º–µ—Ä—ã: 3.18, 3.44, 4.2
        - Job_Duration_Days: –°—Ä–µ–¥–Ω–∏–π —Å—Ä–æ–∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞ –≤ –¥–Ω—è—Ö. –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö integer. –ü—Ä–∏–º–µ—Ä—ã: 1, 54, 46
        - Project_Type: –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç. –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö string. –ü—Ä–∏–º–µ—Ä—ã: Fixed, Hourly
        - Rehire_Rate: –ü—Ä–æ—Ü–µ–Ω—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–≤—Ç–æ—Ä–Ω–æ –Ω–∞–Ω–∏–º–∞—é—Ç —Ñ—Ä–∏–ª–∞–Ω—Å–µ—Ä–∞. –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö float. –ü—Ä–∏–º–µ—Ä—ã: 40.19, 36.53, 74.05
        - Marketing_Spend: –°—É–º–º–∞ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π –≤ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã –≤ –¥–æ–ª–ª–∞—Ä–∞—Ö –°–®–ê. –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö integer. –ü—Ä–∏–º–µ—Ä—ã: 53, 486, 489
        """

        prompt = f"""
        {schema_desc}
        
        –ü—Ä–µ–æ–±—Ä–∞–∑—É–π —Å–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å –≤ Python —Å–∫—Ä–∏–ø—Ç, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏–µ–π eval(). 
        –í –æ—Ç–≤–µ—Ç–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ —Ç—ã –¥–æ–ª–∂–µ–Ω –Ω–∞–ø–∏—Å–∞—Ç—å —Ç–æ–ª—å–∫–æ –∫–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∏–∫–∞–∫ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω.
        –°–∫—Ä–∏–ø—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞–ø–∏—Å–∞–Ω —Å –∏—Å–ø–æ–ª—å—â–æ–≤–∞–Ω–∏–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ pandas. 
        –¢—ã –¥–æ–ª–∂–µ–Ω –Ω–∞–ø–∏—Å–∞—Ç—å –∫–æ–¥, –∫–æ—Ç–æ—Ä—ã–π:
        - –°—á–∏—Ç–∞–µ—Ç –¥–∞—Ç–∞—Å–µ—Ç –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞ "./data/freelancer_earnings_bd.csv"
        - –ü—Ä–æ–∏–∑–≤–µ–¥–µ–Ω –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Å–¥–µ–ª–∞–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–π –∑–∞–ø—Ä–æ—Å
        - –°–æ—Ö—Ä–∞–Ω–∏—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é result
        - –£—á—Ç–∏, —á—Ç–æ –≤—ã–≤–æ–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –¥–æ–ª–∂–µ–Ω —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è —Å–æ–≥–ª–∞—Å—Å–Ω–æ –∑–∞–ø—Ä–æ—Å—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á—Ç–æ–±—ã –µ–≥–æ —É–¥–æ–±–Ω–æ —á–∏—Ç–∞—Ç—å. 
        - –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤—ã–≤–æ–¥ –¥–æ–ª–∂–µ–Ω —Å–æ—Ö—Ä–∞–Ω—è—Ç—å—Å—è –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é result –≤–≤–∏–¥–µ —Å—Ç—Ä–æ–∫–∏
        
        –ö–æ–¥ –Ω–∏ –≤ –∫–æ–µ–º —Å–ª—É—á–∞–µ –Ω–µ –¥–æ–ª–∂–µ–Ω –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª –∏–ª–∏ –µ–≥–æ —á–∞—Å—Ç–∏, —É–¥–∞–ª—è—Ç—å –µ–≥–æ –∏–ª–∏ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞—Ç—å.
        –ï—Å–ª–∏ —Ç—ã –Ω–µ –º–æ–∂–µ—à—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å –Ω–∞–ø–∏—à–∏ - "–Ø –Ω–µ –º–æ–≥—É –≤—ã–ø–æ–ª–Ω–∏—Ç—å –≤–∞—à –∑–∞–ø—Ä–æ—Å. –ú—ã —É–∂–µ —Ä–∞–±–æ—Ç–∞–µ–º –Ω–∞–¥ –æ—à–∏–±–∫–æ–π"
        
        –í–æ–ø—Ä–æ—Å: "{question}"
        
        –ö–æ–¥:
        """

        response = self.model_loader.llm(prompt)
        code = response[0]['generated_text']

        print("üß† –ú–æ–¥–µ–ª—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª–∞ –∫–æ–¥:")
        print(code)

        local_vars = {'df': self.data, 'result': None}

        try:
            exec(code, globals(), local_vars)
            result = local_vars.get('result', '–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã—á–∏—Å–ª–∏—Ç—å')
            return format_answer(question, result)
        except Exception as e:
            return f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∫–æ–¥–∞: {str(e)}"
